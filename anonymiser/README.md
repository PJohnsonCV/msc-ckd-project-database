# Anonymiser
A visual basic macro for Excel to read CSV files and replace a value with a key generated by the anonymiser.

CSV files produced by a laboratory information management system include a patient identifier, the NHS number, which should not be accessible by the research user. This macro is intended to be used by a project supervisor to process the CSV files, translating the NHS number to a study ID and replacing the value in the file which can then be passed to the researcher for processing.
This macro should be saved in a location not accessible by the researcher. The workbook itself is the store of key-value pairs enabling the project supervisor to do a reverse look up when needed.

## Structure
An Excel workbook containing two worksheets: MAIN and patient_renumber, and two VBA modules.

MAIN is presented with some instructions for the user and some user interface elements:
* Browse button
  Opens a Windows file dialog to browser for CSV files. The path and name of the selected file will be displayed in the grey cell, E2.
* Anonymise button
  Will begin the macro, using the file selected in cell, E2.
* Progress timers and incrementing bar
  Timestamps to show the start and end times of file processing, the current record being read, and a visualisation of the % record / sum of records
* File history 
  Automatically filled in when the workbook is open, the anonymise button is clicked, and when the workbook is closed
  
patient_renumber will be empty on first use. If it does not exist when the workook opens, a V2 patch will execute. 
With each use of the macro, this worksheet will populate key-value pairs of NHS numbers and study ids. 

Module 1 contains the macro for anonymising the CSV file.
Module 2 contains the macro for patching the anonymiser from V1 to V2. This is redundant in this release as you will never have used V1. Comments explain whats different in Module 1.

Further VBA can be found on ThisWorkbook which adds the timestamp on Workbook_Open, and Workbook_AfterSave
Workbook_Open also performs the V2 patch check.

## Setup:
Edit Module 1:
BrowseData() fd.InitialFileName should have an absolute path to a folder where CSV files to be processed as saved.
SaveAnonymised() strPath should have an absolute path to a folder where modified CSV files are saved.

## Usage:
Ensure macros are enabled in Excel.
From the 'MAIN' worksheet, click the Browse button to open a file dialog. Select the CSV file to import and click Open.
Click the Anonymise button to begin the process. The progress bar will begin to fill.
Once completed, save and close the workbook (do not Save As), maintaining a single workbook file.
The worksheet patient_renumber will have a column of NHS Numbers and a paired column of study IDs. Use this list to search by the study_id to uncover the paired NHS number.

## CSV Format
The CSV file must be in an expected format, or the file will be rejected. An example is provided with this code.

The macro specifically looks for "PJ eGFR Data" in the second line of the file headers. Then the two header rows, three blank rows, the units row and the final blank row are all deleted, leaving just the column headers as the singular header row in the output CSV file. The following rows are as seen in a file, excluding the illustrative ":":

:"York & Scarborough Blood Sciences    Page: 1 of 1";
:"Data for 01.01.20 to 31.03.20";"PJ eGFR Data   Printed: 12.10.22 15:52";
:
:
:
:"Date Rec'd";"Time Rec'd";"Hospital No.";"Lab No/Spec No";"Sex";"DOB/Age";"LOC";"MSG";"Sodium";"POT";"Urea";"CRE";"eGFR";"AKI";"UMICR";"CRP";"IHBA1C";"HbA1c";"Hb";"HCT";"MCH";"PHO";
:;;;;;;;;"mmol/L";"mmol/L";"mmol/L";"umol/L";"mL/min/";;"mg/mmol";"mg/L";"mmol/mo";"mmol/mo";"g/L";"L/L";"pg";"mmol/L";
:


## Version 2 Patcher
To update the extremely slow processing loop of version 1, while maintaining the already generated set of study IDs, the patcher needed to copy data from the V1 file into itself.
The original issue remains commented out in the Module1.UpdateStudyID function where the loop was checking the entire list manually until it found a match. This was replaced with Excel's search function. 

First, it checks for the existence of patient_renumber in itself when the workbook is opened, if the worksheet is missing, the patcher will execute in full.
Next, a file dialog will open to ask the user to pick the V1 Anonymiser file. 
The macro then copies the V1 sheet, patient_renumber, twice into the V2 workbook - once for continued use, and once for backup.
The user is prompted to check that both patient_renumber sheets exist, and to save the V2 workbook and reopen it.
Once reopened, because patient_renumber now exists, the patcher shouldn't take any further action. 
The V1 anonymiser can now be deleted.
 
